# STM32_CAN通讯开发调试记录_过滤器设置

https://github.com/MatthewChow03/CANbus-Filtering

一直有想写一点技术文章的想法，无奈自己水平比较菜，主流的FOC控制系列感觉网友们已经做的非常好了，而偏偏自己做的效果又拿不上台面。于是我来写一点比较冷门的内容，就从最近在做的CAN通讯开始吧。

## 需求分析

举一个小例子：现有一台两轴机械臂，使用者想要控制各个关节按如下方式运动：关节1转30deg，关节2转10deg，CAN通讯层面如何实现？

有读者看了会说，这很简单嘛！

第一步，主控制器(master)依次向所有驱动器(slave)发送如下表的两组数据：

| 数据组 | data[0] | data[1] |
| ------ | ------- | ------- |
| 1      | 0x01    | 0x1e    |
| 2      | 0x02    | 0x0a    |

*：0x1e和0x0a分别是30和10的十六进制表达。

第二步，在关节驱动器软件层加入如下代码：

```
if (data[0] == joint_id){
	target_position = data[1];
}
```

配合驱动器自身的控制代码，就可以让机械臂动起来了。

这当然是完全正确的方式，事实上我之前开发基于串口通讯的机械臂时，几乎用的就是这种方法（实际代码实现会复杂一些，但原理完全一致），但这样其实舍弃掉了CAN通讯里一项非常伟大的功能：过滤器。

## 举个例子

打个比方来描述过滤器的作用：

领导（主控制器）每次给大家安排工作时，都把所有员工（各个驱动器）叫来开一场大会，在会上依次安排每个人的工作。对于每个员工，每次安排工作时都需要完整地听完所有的工作安排，对于和自己无关的信息，听到后不作反应（`data[0]!=joint_id`的情况）；对于和自己有关的信息，作出响应（`data[0]==joint_id`的情况）。

这样很显然对于领导来说非常省事（主控制器软件开发工作量很小），但对于员工却非常不友好：每次安排工作均需要占用自己大量的时间（通讯耗时长），而且随着员工越来越多（驱动器数量增多），每次开会的信息量会越来越大（数据量增大），占用的时间也越来越长。

为了提升打工人的工作效率，领导想出了一个新办法：组建一个微信群，每次安排工作时按照如下格式发送消息：

@张三：下周完成端茶送水时脚步音量和音色对领导心情的研究；

@李四：下周完成扫地时手指抓握扫把力度和位置对地面整洁度的研究；

…………

各个员工在加入微信群后，由于对领导长期开大会占用时间不满，立即屏蔽了微信群，那么张三只有在被@到时才会被动看到信息，其余的信息则自动被屏蔽掉了。这样一来，大大提高了工作效率，相比旧的工作方法，新的方法额外增加了以下两点内容：

1）领导每次安排工作时，都需要额外@对应的责任人（通讯的发送方需要给信息配置相应的地址）

2）员工需要知道哪些信息是可以被屏蔽的，哪些则是自己需要的（通讯的接收方需要设置过滤器的值）

如此优雅的新型工作方法，在CAN通讯中被称作：过滤器（Filter）。

## 过滤器的使用方法

本文仅介绍idMask模式下的过滤器，也即：驱动器需要知道哪些信息是需要care的，并关注这些信息的内容。

首先我们来看过滤器结构体的配置：

```

```

其中需要特别说明的只有以下四个成员的值：

```

```

XX和XX决定了哪些信息是需要care的

XX和XX决定了这些被care的值应该是多少

下面举例说明：

仍然是



主控制器发送如下数据帧：

Address1 3000

Address2 4365

Address3 2500